--- 
layout: post
name: aop-crosscutting-ii
title: "AOP: crosscutting (II)"
time: 2010-06-19 11:03:00 +02:00
---
<div style="text-align: justify;">Durante la <a href="http://miguelinlas3.blogspot.com/2010/05/aop-crosscutting-i.html">última entrada</a> de la serie relacionada con la programación orientada a aspectos analizamos el modo en el que se puede alterar el comportamiento de un sistema, analizando las categorías de advices y realizando una comparativa con los métodos de una clase. A lo largo de esta entrada realizaremos un análisis en profundidad de los <b><i>advices</i></b>.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><b><span style="font-size: large;">Before advice</span><br /></b>Este tipo de advices se ejecutan antes de la ejecución del joint point sobre el que actúan. En el siguiente ejemplo:</div><div style="text-align: justify;"><br /></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace; text-align: justify;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; before():execution(@Secured * * (..)){</span></div><div style="text-align: center;"><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; // asegurarse de que el usuario puede realizar la operación</span></span><br /><div style="text-align: left;"><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; </div></div><div style="text-align: justify;"><br />el advice realiza una comprobación de seguridad antes de que se produzca la ejecución de cualquier método anotado con <i>Secured.</i><br /><br />En caso de que el advice dispare un excepción, el joint point no se ejecutará. Este tipo de advices son comúnmente utilizados en aspectos tales como seguridad o trazabilidad.</div><div style="text-align: justify;"><span style="font-size: large;"><b>After advice</b></span><br /><br />Se ejecutan después de la ejecución del joint point sobre el que actúan.Dentro de esta categoría, <b>AspectJ </b>ofrece tres tipos de advices:</div><ul><li>Ejecución del advice independientemente del resultado de la ejecución del joint point.</li><li>Ejecución del advice única y exclusivamente si el joint point ha finalizado correctamente.</li><li>Ejecución del advice después que el joint point haya disparado una excepción.</li></ul><div style="text-align: justify;">Veamos en detalle cada uno de los tres tipos anteriores:<br /><br /><b>1.- Advice After</b><br />Este tipo de advices se ejecutan independientemente del resultado de la ejecución del joint point sobre el que actúan.Habitualmente se conoce a este tipo de advices como after finally puesto que su semántica es similar a la de un bloque <i>finally</i>.<br /><br />El siguiente advice:</div><div style="text-align: justify;"><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; after(): call(@Logging * ServiceManager.*(..)){</span></span><br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // registrar el resultado de la operación</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></div><span style="font-size: x-small;"><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /></span>registra el resultado de todas las operaciones de la clase <i>ServiceManager</i> que estén marcadas con la anotación <i>Logging</i>, independientemente si retornan correctamente o terminan su ejecución de forma inesperada mediante el disparo de una excepción.<br /><br /><b>2.-Advice After Returning</b><br />En muchas ocasiones,será necesario ejecutar el código de nuestro advice única y exclusivamente cuando la ejecución del joint point haya terminado de forma correcta. Continuando con el ejemplo anterior:<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; after () returning: call(@Logging * ServiceManager.*(..)){</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // registrar el resultado de la operación</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div>se seguirá registrando el resultado de las operaciones, siempre y cuando, la ejecución haya terminado correctamente, sin el disparo de ninguna excepción.<br /><br />AspectJ ofrece una pequeña variante para este tipo de advices:<br /><br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace; text-align: center;"><span style="font-size: x-small;">after() returning (ReturnType returnObject)</span></div><br />gracias a la cual se permite recuperar el objeto retornado por la ejecución del joint point dentro del advice. Veamos un pequeño ejemplo ilustrativo:<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; after() returning (java.sql.Connection connection):</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; call(java.sql.Connection DriverManager.getConnection(..)){</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;&nbsp; System.out.println("Se ha recuperado la conexión "</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; + connection);</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></div><br />Es importante tener claro que no se puede retornar un objeto nuevo (sí puede ser modificado pero no retornar uno nuevo).<br /><br /><span style="font-size: small;"><b>3.- Advice After Exception</b></span><br />Este tipo de advices son similares a los descritos en el apartado anterior. En este caso, el advice se ejecutará única y exclusivamente cuando el joint point dispare una excepción. Presentan la siguiente estructura:<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace; text-align: center;"><span style="font-size: x-small;">after() throwing:execution (* ServiceManager+.*(..))</span></div>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br />El advice del ejemplo anterior se ejecutará siempre y cuando algún método de la clase <i>ServiceManager </i>(o alguna de sus subclases) dispare una excepción. En el supuesto de que la ejecución del joint point termine correctamente, este tipo de advices no serán ejecutados.<br /><br />Al igual que los advices del apartado anterior, <i>AspectJ</i> ofrece un modo de recuperar la excepción que ha sido disparada por el joint point de manera que esté disponible en el cuerpo del advice. Siguiendo una sintaxis similar a la anterior, tendríamos:<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; <br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace; text-align: center;"><span style="font-size: x-small;">after() throwing (ExceptionType exceptionObject):</span></div>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br />Un after throwing advice nunca podrá tragarse la excepción, por lo que seguirá subiendo por la pila de llamadas hasta llegar al objeto que realizó la invocación del joint point.<br /><br /><b><span style="font-size: large;">Around advice</span></b><br />Este clase de advices engloban al joint point, pudiendo ejecutar la lógica del mismo un número indefinido de veces. Incluso pueden omitir la ejecución del propio joint point. Algunos de los usos principales de este tipo de advices son los siguientes:<br /><ul><li>Ejecución de lógica adicional antes y después de la ejecución de un joint point, como por ejemplo, acciones de profiling.</li><li>Omitir la ejecución original, y realizar otra en su lugar, como por ejemplo, operaciones con cachés.</li><li>Envolver la operación con el objetivo de aplicar una política de gestión de excepciones. Un ejemplo de este uso sería la gestión de transacciones.</li></ul>Este advice ofrece una potencia superior a todos los advices vistos hasta el momento, puesto que podrían sustituir a los anteriores. De todos modos, se considera una buena práctica utilizar el advice más sencillo que cumpla las necesidades de la tarea que necesita ser llevada a cabo.<br /><br />Si desde el around advice se desea llevar a cabo la ejecución del joint point, será necesario hacer uso de la palabra reservada <i>proceed()</i> dentro del cuerpo del advice. Recuérdese que, puesto que la invocación de <i>proceed() </i>ejecuta el joint point, deberán pasarse el mismo número de argumentos que han sido recolectados por el advice.<br />Asimismo, puesto que la invocación de <i>proceed()</i> supone la ejecución del joint point, el valor de retorno será el retornado por éste último.<br /><br />A continuación se adjunta un pequeño ejemplo de utilización de advices de este tipo:<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; <br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void around(User user,int credits) </span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throws InsufficientCreditsException:</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; call(* User.pay*(int)) &amp;&amp; target(user) &amp; &amp;&nbsp; args(credits){</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; try</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; proceed(user,credits);</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }catch(InsufficientCreditsException ex){</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if(!processException()){</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; throw ex;</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</span></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><br /></span></div>Analicemos en detalle la construcción anterior:<br /><ol><li>El pointcut selecciona cualquier llamada a los métodos de la clase <i>User</i> cuyo nombre comience por <i>pay </i>y disparen una excepción de tipo <i>InsufficientCreditsException</i>.</li><li>La segunda parte del pointcut recolecta el contexto del joint point: el usuario sobre el que se está realizando la llamada y el número de créditosque se están pasando como argumento del método que se está ejecutando.</li><li>En el cuerpo del advice, se engloba la ejecución del método con un bloque de gestión de excepciones, para realizar una protección adicional en caso de que se produzca una excepción. En el caso de que la protección adicional no sea correcta, la excepción será disparada de nuevo.</li></ol></div><div style="text-align: justify;">Todos los around advices deben declarar un valor de retorno (pudiendo ser void). Habitualmente el tipo de retorno de éstos se corresponde con el tipo de retorno de los joint points sobre los que está actuando.<br />En algunas ocasiones, todos los joint points sobre los que actúa el advice no presentan el mismo tipo de retorno, como puede ocurrir cuando estamos añadiendo soporte transaccional a diferentes&nbsp; operaciones. En estas situaciones el tipo de retorno que debe declarar el advice será Object. AspectJ acomodará el valor de retorno de acuerdo a las&nbsp; siguientes reglas:<br /><ul><li>Si se está retornando un tipo primitivo, AspectJ realizará el boxing/unboxing correspondiente. Esta característica es similar a la incluida a partir de Java 5, pero AspectJ no precisa de dicha versión de Java para realizar la operación.</li><li>En el caso en el que el tipo de retorno no sea primitivo, AspectJ realizará los casts oportunos antes de retornar el valor.</li></ul>Muchas ocasiones es necesario acceder a los objetos que conforman la ejecución del joint point para que el advice pueda llevar a cabo la lógica correspondiente. Por tanto, los pointcuts, necesitan exponer el contexto disponible en la ejecución del joint point de modo que pueda estar disponible en el cuerpo del advice. Dicho contexto puede definirse de dos modos diferentes: <br /><ul><li>Objetos (incluyendo los tipos primitivos) que conforman el joint point.</li><li>Anotaciones asociadas al joint point.</li></ul>La siguiente tabla describe el conjunto de pointcuts que AspectJ ofrece para recuperar el contexto en los joint points.</div><br /><div id="table"><table border="1" frame="void" id="d0e3506"><caption>Table 1.14. Pointcuts para recuperar el contexto en un <span class="italic">joint point</span></caption><col width="25%"></col><col width="75%"></col><thead><tr>         <th>Pointcut</th>         <th>Contexto recuperado</th>        </tr></thead><tbody><tr>         <td><span class="italic">this(obj)</span></td>         <td>Objeto <span class="italic">this</span> en el <span class="italic">joint point</span> que se está<br />ejecutando</td>         </tr><tr>         <td><span class="italic">target(obj)</span></td>         <td>Objetivo de la llamada en el <span class="italic">joint<br />point</span> que se está ejecutando. En el caso de un<br /><span class="italic">joint point</span> de una<br />llamada a un método, el <span class="italic">target</span> será el objeto que realiza la llamada.<br />Para la ejecución de un método, el <span class="italic">target</span> será el objeto <span class="italic">this</span>. En los accesos a campos, el <span class="italic">target</span> será el objeto que se está<br />accediendo. En el resto de <span class="italic">joint<br />points</span> no existe un <span class="italic">target</span> disponible</td>         </tr><tr>         <td><span class="italic">args(obj1,obj2,...)</span></td>         <td>Objetos que representa los argumentos en el <span class="italic">joint point</span>. Para las<br />llamadas/ejecuciones de métodos/constructores, recupera los<br />argumentos de los mismos. En el caso de los manejadores de<br />excepciones, recupera la excepción producida. Para los accesos<br />en modo escritura a un campo, recupera el nuevo valor del<br />campo.</td>        </tr><tr>         <td><span class="italic">@this(annot)</span></td>         <td>Anotación asociada con el tipo del objeto <span class="italic">this</span> del <span class="italic">joint point</span></td>         </tr><tr>         <td><span class="italic">@target(annot)</span></td>         <td>Anotación asociada con el tipo del objeto <span class="italic">target</span> del <span class="italic">joint point</span></td>        </tr><tr>         <td><span class="italic">@args(annot1, annot2,<br />...)</span></td>          <td>Anotación asociada con el tipo de los argumentos del <span class="italic">joint point</span></td>        </tr><tr>         <td><span class="italic">@within(annot)</span></td>         <td>Anotación asociada con el tipo "enclosing" del <span class="italic">joint point</span></td>        </tr><tr>         <td><span class="italic">@withincode(annot)</span></td>          <td>Anotación asociada con el método "enclosing" del <span class="italic">joint point</span></td>        </tr><tr>         <td><span class="italic">annotation(annot)</span></td>         <td>Anotación asociada con el asunto actual del <span class="italic">joint point</span>.</td>        </tr></tbody></table></div><div><br />Durante la próxima entrada analizaremos el concepto de <b>Aspecto.</b><br /><br />Hasta pronto!<b> </b></div><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/35092134-2557713392820572475?l=miguelinlas3.blogspot.com' alt='' /></div>
