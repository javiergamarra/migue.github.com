--- 
layout: post
name: parser-combinators-parsing-simple
title: "Parser Combinators: Parsing simple bytecode"
time: 2011-05-07 17:40:00 +02:00
---
<div style="text-align: justify;">Anteriormente,&nbsp;<a href="http://miguelinlas3.blogspot.com/2011/03/parser-combinators-un-poco-de-teoria.html">http://miguelinlas3.blogspot.com/2011/03/parser-combinators-un-poco-de-teoria.html</a>, introducíamos de manera somera el concepto de parser combinators y parte de la teoría relacionada con los mismos. Durante esta entrada vamos a construir un sencillo parser que nos permita analizar un conjunto mínimo de instrucciones de la máquina virtual java (simplemente permitiremos la definición de funciones y la capacidad de ejecución de las mismas).</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">No analizaremos en detalle el funcionamiento de la máquina virtual java ni el conjunto de instrucciones &nbsp;de la misma (podríamos llevarnos algo más que unos cuantos posts :) ) dado que el objetivo principal de esta entrada es profundizar en el concepto de parser combinators y presentar un ejemplo de uso real de los mismos. Pongámonos manos a la obra.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">El código fuente que nos servirá como conductor de la entrada será el de la función factorial mostrado a continuación:</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">static int fact(int);</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">Code:</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">Stack=2, Locals=3, Args_size=1</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">0: iconst_1</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">1: istore_1</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">2: iconst_1</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">3: istore_2</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">4: iload_2</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">5: iload_0</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">6: if_icmpgt 19</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">9: iload_1</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">10: iload_2</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">11: imul</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">12: istore_1</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">13: iinc 2, 1</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">16: goto 4</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">19: iload_1</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">20: ireturn</span></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Podréis objener el código desensamblado como el mostrado anteriormente mediante el comando <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">javap -v Class</span> donde Class represente un archivo bytecode.<br /><br />El proceso de parsing se lleva a cabo mediante el uso de parser combinators (no perdamos de vista el objetivo de nuestra entrada ;) ) y presenta las siguientes características<br /><br /><ol><li>Para cada una de las diferentes tipos de instrucciones soportadas definimos un parser combinator que es el encargado de parsear este tipo de instrucciones.</li><li>Cada uno de los parsers anteriores sabe cómo generar un objeto del tipo correspondiente. Se utiliza una jerarquía de tipos en la que cada una de las instrucciones bytecode soportadas está representada mediante una clase Scala.</li><li>El parser global construye un AST (en este caso es un simple lista de objetos) y un conjunto de infraestructura adicional con el objetivo de implementar un intérprete que ejecute la secuencia de instrucciones obtenida (fuera del ámbito de esta entrada podéis echarle un vistazo al código fuente)</li></ol><div>¿Cómo actúan nuestros diferentes parsers? Analicemos por ejemplo el componente encargado de parsear las instrucciones ISTORE</div><div><br /></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">lazy val beginInstructionFragment: Parser[Int] = integer &lt;~ ":" ^^ { _.toInt}</span></div><div><br /></div><div><div style="text-align: left;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">lazy val iStoreBytecode: Parser[List[BytecodeInstruction]] = beginInstructionFragment ~&gt; "istore_" ~ integer ^^ {</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">&nbsp; &nbsp; case name ~ value =&gt; new IStoreInstruction(name,value) &nbsp;:: List()</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">&nbsp; }</span></div></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;"><br /></span></div><div><div style="font-size: small;"><span class="Apple-style-span" style="font-family: inherit; font-size: small;">El parser </span><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">beginInstructionFragment</span><span class="Apple-style-span" style="font-family: inherit; font-size: small;"> es el encargado de parsear la primera parte de la instrucción, la que corresponde al lugar que ocupa la instrucción en el array de instrucciones.&nbsp;</span></div><div style="font-size: small;"><span class="Apple-style-span" style="font-family: inherit; font-size: small;"><br /></span></div><div style="font-size: small;"><span class="Apple-style-span" style="font-family: inherit; font-size: small;">El segundo parser hace uso del primero y además sabe cómo parsear el texto restante de manera adecuada. En este caso nuestro este analizador es capaz de parsear las instrucciones istore_N donde N representa un número entero positivo cualquiera y devolver un objeto (dentro de una lista) de tipo IStoreInstruction en el que se incluyen el nombre de la instrucción y el entero correspondiente.</span></div><div style="font-size: small;"><span class="Apple-style-span" style="font-family: inherit; font-size: small;"><br /></span></div><div style="font-size: small;"><span class="Apple-style-span" style="font-family: inherit; font-size: small;">Como seguramente a muchos de los lectores de este post el fragmento de código anterior les suene un poco raro intentaremos analizar las diferentes opciones de combinaciones de parsers disponibles</span><span class="Apple-style-span" style="font-family: 'Times New Roman'; font-size: small;">:</span></div><div><ul><li>Si escribimos un parser en el que utilizamos una cadena, como por ejemplo "istore", el resultado es la propia cadena.</li><li>Podemos utilizar expresiones regulares, como por ejemplo, <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">"[A-Z]".r</span> . En este caso el resultado también sería la propia cadena</li><li>Si utilizamos el símbolo ~ (composición secuencial) el resultado del proceso de parseo será la combinación de ambos resultados. Por tanto, si A devuelve "X" y B devuelve "true", el resultado de A~B sería &nbsp;~("X","true") (el tipo de este resultado sería una <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">case class</span> de tipo ~ . Adicionalmente podemos hacer uso de los operadores &lt;~ y ~&gt; los cuales mantienen los valores a la izquierda y a la derecha respectivamente.</li><li>Otro elemento de combinación de parsers sería | . En este caso el valor de retorno sería el de aquel parser que pudiera parsear la entrada con éxito.</li><li><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">rep(P) o rep(P,separator)</span> retornan una lista de las múltiples ejecuciones de P.</li><li>opt(P) retorna una instancia de tipo <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">Option</span>.</li></ul><div>Adicionalmente a la combinación de los parsers, necesitaremos un mecanismo que nos permita reescribir la salida de los mismos, en nuestro caso para instanciar los objetos de tipo necesario y configurar nuestro AST. Para ello tendremos que hacer uso del operador de transformación ^^.</div></div><div><br /></div><div>Una definición formar del operador anterior sería: Dado un parser P y una funcion f cualesquiera, una expresión del tipo P^^f implica que para cada resultado R de P el resultado de la expresión global es f(R)&nbsp;</div><div style="font-family: 'Courier New', Courier, monospace; font-size: small;"><span class="Apple-style-span" style="font-family: 'Times New Roman'; font-size: small;"><br /></span></div><div>En el ejemplo que estamos tratando nuestra función es un simple pattern matching que transforma la case class retornada por nuestra combinación de parsers en un objeto de tipo&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">IStoreInstruction.</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;"><br /></span></div><div><span class="Apple-style-span" style="font-size: x-small;"><span class="Apple-style-span" style="font-family: inherit; font-size: small;">No me ha resultado sencillo ponerlo por escrito y tampoco estoy seguro de que me haya explicado con la mayor claridad posible. Si estáis interesados os recomiendo que clonéis el repositorio alojado en</span><span class="Apple-style-span" style="font-family: 'Times New Roman'; font-size: small;"> <a href="https://github.com/">GitHub</a></span></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;"><span class="Apple-style-span" style="font-family: 'Times New Roman'; font-size: small;"><br /></span></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">git://github.com/migue/parser-combinators.git</span></div><div><br /></div><div>Hasta pronto!</div></div></div><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/35092134-4557706418707350651?l=miguelinlas3.blogspot.com' alt='' /></div>
