--- 
layout: post
name: aop-crosscutting-i
title: "AOP: crosscutting (I)"
time: 2010-05-30 20:03:00 +02:00
---
<div style="text-align: justify;">A lo largo de las entradas anteriores hemos analizado el modelo de <i><b>joint point</b></i> de <i><b>AspectJ </b></i>y la manera de definir las reglas que permitan seleccionar aquellos <i><b>joint points</b></i> de nuestro interés.&nbsp;</div><div style="text-align: justify;">Durante esta entrada analizaremos el modo en el que se puede alterar el comportamiento de un sistema en los <i><b>joint points</b></i> seleccionados mediante la definición de los pointcuts.</div><div style="text-align: justify;"><br /></div><b>Descripción general</b><br /><b><br /></b><br />Las reglas de tejido están compuestas de dos partes:<br /><br /><ul><li><b><i>advice</i></b>: qué deseamos hacer.</li><li><b><i>pointcuts</i></b>: dónde aplicamos el advice anterior.</li></ul><br /><b><i>AspectJ </i></b>soporta el crosscutting dinámico mediante el concepto de <b><i>advices</i></b>, construcciones similares a los métodos gracias a los cuales se permiten definir las acciones a ejecutar en los <i><b>joint points</b></i> seleccionados por un <i><b>pointcut</b></i>.<br /><br /><b>Categorías de advices</b><br /><b><br /></b><br />Dependiendo de las funcionalidades que se estén implementando será necesario llevar a cabo la lógica en un determinado lugar del flujo de ejecución original; así por ejemplo, si se está construyendo la seguridad de un sistema, el código tendrá que verificar dicha seguridad antes de la ejecución del <i><b>joint point</b></i>. En un sistema de cachés, la nueva funcionalidad tendría que ejecutarse alrededor del joint point original, intentando recuperar el valor de la caché, y en caso de que no exista, ejecutar el código real y añadirlo a la misma para futuras invocaciones. <b><i>AspectJ</i></b> ofrece tres categorías de advices que satisfacen los escenarios anteriores (y alguno más):<br /><br /><ul><li><i><b>Before Advice</b></i>: se ejecutan anteriormente a la ejecución del <b><i>joint point</i></b></li><li><i><b>After Advice</b></i>: se ejecutan posteriormente a la ejecución del <i><b>joint point</b></i>. Existen tres variantes diferentes</li><ul><li><b><i>After finally</i></b>: se ejecuta tras la ejecución del join point independientemente del resultado de la misma.</li><li><i><b>After returning</b></i>: se ejecuta tras la ejecución del <i><b>joint point</b></i> siempre y cuando ésta última haya finalizado correctamente, es decir, sin lanzar ninguna excepción.</li><li><i><b>After throwing</b></i>: se ejecuta tras la ejecución fallida de un <i><b>joint point</b></i>, es decir, después de que dicho <i><b>joint point</b></i> dispare una excepción.</li></ul><li><i><b>Around Advice</b></i>: rodean la ejecución del <i><b>joint point</b></i>.</li></ul><br /><br /><b>Sintaxis de los advices</b><br /><b><br /></b><br />Aunque la sintaxis varía ligeramente dependiendo del tipo de advice que se esté escribiendo, se podría dividir su estructura general en tres partes claramente diferenciadas:<br /><br /><ul><li><b>Declaración del advice</b>. En esta parte de la declaración se especifica el momento de ejecución del <b><i>advice</i></b>, es decir, si se ejecutará antes, después o alrededor de los <i><b>joint points</b></i>.</li><li><b>Definición de los <i>pointcuts</i></b>. Se especifican los <i><b>pointcuts </b></i>sobre los que se desea actuar.</li><li><b>Cuerpo del <i>advice</i></b>. Definición del código a ejecutar una vez se haya alcanzado el <i><b>joint point</b></i> indicado.</li></ul><br />Veamos, por partes, un ejemplo sencillo de definición de un advice:<br /><br /><br /><ul><li>&nbsp;En primer lugar se define un sencillo pointcut :</li></ul><br /><div style="text-align: center;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><span class="Apple-style-span" style="font-size: small;">pointcut secureOperation(User user):&nbsp;call( * User.*(..)) &amp;&amp; target(user)</span></span></div><br /><br /><ul><li>En el pointcut anterior estamos capturando todas las llamadas a cualquier método de la clase User, y, adicionalmente estamos recogiendo el objeto que actúa como target de la llamada.&nbsp;A continuación veremos un around advice para ilustrar la sintaxis:</li></ul><br /><div style="text-align: left;"><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Object around(User user):secureOperation(user){</span></span></div><div style="text-align: left;"><span class="Apple-tab-span" style="white-space: pre;"><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">            </span></span></span><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">Syst</span></span><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: small;">em.out.println("Securing operation on user "&nbsp;</span></div><div style="text-align: left;"><span class="Apple-tab-span" style="white-space: pre;"><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">                                  </span></span></span><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">+ user.toString());</span></span></div><div style="text-align: left;"><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"></span></span><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace; font-size: small;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Object retValue = proceed(user);</span></div><div style="text-align: left;"><span class="Apple-tab-span" style="white-space: pre;"><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">          </span></span></span><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">System.out.println("Finished secured operation on user "&nbsp;</span></span></div><div style="text-align: left;"><span class="Apple-tab-span" style="white-space: pre;"><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">      </span></span></span><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">+ user.toString());</span></span></div><div style="text-align: left;"><span class="Apple-tab-span" style="white-space: pre;"><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">           </span></span></span><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">return retValue;</span></span></div><div style="text-align: left;"><span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></span></div><br /><ul><li>En la definición anterior se puede ver la estructura de la declaración de un <i><b>advice </b></i>descrita anteriormente:</li><ul><li>La parte que precede a los dos puntos indica el momento de ejecución del <b><i>advice </i></b>(<i><b>after,before,around</b></i>). En este caso, se ejecutará alrededor del joint point seleccionado.</li><li>La parte que sigue a los dos puntos representa el <b><i>pointcut</i></b>, es decir, la definición de los criterios que determinan cuándo se ejecutará el <i><b>advice</b></i>.</li><li>La última parte representa el cuerpo del <i><b>advice</b></i>, es decir, el código que se ejecutará cuando alguno de los <b><i>joint point</i></b> definidos por el <b>pointcut </b>sea alcanzado.</li></ul></ul><br /><b>Advices y métodos</b><br /><br />Al igual que los métodos de una clase, los <b><i>advices</i></b> se utilizan para definir comportamiento. La sintaxis de éstos últimos es similar a la de los métodos aunque existen algunas diferencias dado que los <i><b>advices</b></i> son aplicados de manera automática, sin la necesidad de realizar explícitamente la invocación del mismo.<br /><br />A continuación se analizan las similitudes entre ambos en tres categorías diferentes: declaración, cuerpo y comportamiento.&nbsp;La declaración de un <b><i>advice</i></b> es similar a la signatura de un método tradicional en que:<br /><ul><li>Opcionalmente puede asignarse un nombre al advice mediante el uso de la anotación @AdviceName.</li><li>Recibe argumentos a través del contexto del <i><b>joint point</b></i>, que posteriormente podrán ser utilizados en el cuerpo para implementar la lógica necesaria.</li><li>Puede declarar el lanzamiento de una excepción.</li><li>El cuerpo de los <b><i>advices </i></b>también es muy parecido al de los métodos puesto que:</li><li>El código del cuerpo del <b><i>advice </i></b>sigue las mismas reglas de acceso a miembros de otros tipos y/o aspectos.</li><li>Se puede referenciar a la propia instancia del aspecto mediante el uso de this.</li><li>Los <i><b>advices </b></i>de tipo <b><i>around </i></b>pueden retornar un valor.</li><li>Los <i><b>advices </b></i>deben declarar las excepciones que sean checked que la implementación podría disparar.</li><li>En la categoría relativa al comportamiento, los <i><b>advices </b></i>:</li><li>No pueden declarar el disparo de una excepción que no está declarada en TODOS los <i><b>joint points</b></i> sobre los que actúa.</li><li>Pueden omitir algunas de las excepciones de tipo checked que han sido declaradas por alguno de los <i><b>joint point</b></i> sobre los que actúa.</li><li>Pueden declarar el disparo de excepciones más específicas (de tipo checked) que las definidas por los <i><b>joint point</b></i> sobre los que está actuando.</li><li>Pueden lanzar cualquier tipo de excepción de tipo runtime.&nbsp;</li></ul><br />En comparación con los métodos, los advices presentan las siguientes diferencias:<br /><br /><ul><li>La declaración de un nombre es opcional.</li><li>No pueden ser invocados directamente.</li><li>No presentan especificadores de acceso (relacionado con la característica de que no pueden ser invocados directamente).</li><li>No presentan un tipo de retorno en los advices de tipo <i><b>before <span class="Apple-style-span" style="font-style: normal;"><span class="Apple-style-span" style="font-weight: normal;">y</span></span> after</b></i>.</li><li>Tienen acceso a unas cuantas variables dentro del propio aspecto: thisJointPoint, thisJointPointStaticPart, thisEnclosingJointPointStaticPart.</li><li>Se puede utilizar la palabra reservada <b><i>proceed </i></b>en los <b><i>advices </i></b>de tipo <i><b>around </b></i>para ejecutar el <i><b>joint point</b></i> sobre el cual se está realizando el <i><b>advice</b></i>.</li></ul><br />La siguiente entrada realizará un análisis más detallado de los <i><b>advices </b><span class="Apple-style-span" style="font-style: normal;">y cómo se puede acceder a los contextos del </span><b>joint point.</b></i><br /><i><b><br /></b></i><br />Hasta pronto!!<div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/35092134-7408218044157387291?l=miguelinlas3.blogspot.com' alt='' /></div>
